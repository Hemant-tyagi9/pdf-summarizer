<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF SmartNotes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: var(--bs-body-bg);
      color: var(--bs-body-color);
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
    }
    .drop-zone {
      border: 2px dashed #6c757d;
      padding: 2rem;
      text-align: center;
      border-radius: 1rem;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      user-select: none;
    }
    .drop-zone.dragover {
      background-color: rgba(0, 123, 255, 0.1);
      border-color: #007bff;
    }
    .summary-box {
      background-color: var(--bs-secondary-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 2rem;
      white-space: pre-wrap;
    }
    .spinner-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    .spinner-content {
      background-color: var(--bs-body-bg);
      padding: 2rem;
      border-radius: 1rem;
      text-align: center;
    }
    .spinner-lg {
      width: 3rem;
      height: 3rem;
    }
  </style>
</head>
<body>
  <!-- Loading Spinner Overlay -->
  <div id="spinnerContainer" class="spinner-container">
    <div class="spinner-content">
      <div class="spinner-border spinner-lg text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Processing your PDF...</p>
    </div>
  </div>

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">ðŸ“„ PDF SmartNotes</h1>
      <button id="themeToggle" class="btn btn-outline-secondary" aria-label="Toggle light/dark mode">
        <i class="bi bi-sun-fill"></i> Light Mode
      </button>
    </div>

    <form id="uploadForm" enctype="multipart/form-data" novalidate>
      <div id="dropZone" class="drop-zone mb-3" tabindex="0" aria-label="Drag and drop PDF file here or click to select">
        <p class="mb-0">Drag & Drop your PDF here or click to select</p>
        <input type="file" name="pdf" id="pdfInput" accept="application/pdf" hidden required />
      </div>
      <div class="mb-3">
        <label for="languageSelect" class="form-label">Select Language:</label>
        <select class="form-select" id="languageSelect" name="language" aria-describedby="languageHelp">
          <option value="english" selected>English</option>
          <option value="hindi">Hindi</option>
        </select>
        <div id="languageHelp" class="form-text">Choose the language for summarization.</div>
      </div>
      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Generate Notes
        </button>
        <div class="progress mt-2" style="height: 6px;">
          <div id="uploadProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
    </form>

    <div id="alerts"></div>
    <div id="results" class="mt-4" role="region" aria-live="polite"></div>
  </div>

  <script>
    (function () {
      const html = document.documentElement;
      const themeToggle = document.getElementById("themeToggle");
      const form = document.getElementById("uploadForm");
      const dropZone = document.getElementById("dropZone");
      const pdfInput = document.getElementById("pdfInput");
      const uploadProgress = document.getElementById("uploadProgress");
      const resultsContainer = document.getElementById("results");
      const alertsContainer = document.getElementById("alerts");
      const submitBtn = document.getElementById("submitBtn");
      const spinnerContainer = document.getElementById("spinnerContainer");

      // Initialize theme from localStorage or default to dark
      function loadTheme() {
        const savedTheme = localStorage.getItem("theme");
        if (savedTheme === "light") {
          html.setAttribute("data-bs-theme", "light");
          themeToggle.innerHTML = `<i class="bi bi-moon-fill"></i> Dark Mode`;
        } else {
          html.setAttribute("data-bs-theme", "dark");
          themeToggle.innerHTML = `<i class="bi bi-sun-fill"></i> Light Mode`;
        }
      }

      // Toggle theme and save preference
      themeToggle.addEventListener("click", () => {
        const currentTheme = html.getAttribute("data-bs-theme");
        if (currentTheme === "dark") {
          html.setAttribute("data-bs-theme", "light");
          themeToggle.innerHTML = `<i class="bi bi-moon-fill"></i> Dark Mode`;
          localStorage.setItem("theme", "light");
        } else {
          html.setAttribute("data-bs-theme", "dark");
          themeToggle.innerHTML = `<i class="bi bi-sun-fill"></i> Light Mode`;
          localStorage.setItem("theme", "dark");
        }
      });

      // Drag and drop handling with keyboard support
      function initFileSelection() {
        dropZone.addEventListener("click", () => pdfInput.click());
        dropZone.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            pdfInput.click();
          }
        });

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("dragover");
        });

        dropZone.addEventListener("dragleave", () => {
          dropZone.classList.remove("dragover");
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("dragover");
          if (e.dataTransfer.files.length) {
            if (e.dataTransfer.files[0].type !== "application/pdf") {
              showAlert("Please upload a valid PDF file.", "danger");
              return;
            }
            pdfInput.files = e.dataTransfer.files;
          }
        });
      }

      // Show alert message (supports multiple alerts)
      function showAlert(message, type = "info") {
        // Clear previous alerts after 5 seconds
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.role = "alert";
        alertDiv.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        alertsContainer.appendChild(alertDiv);

        setTimeout(() => {
          alertDiv.classList.remove("show");
          alertDiv.classList.add("hide");
          alertDiv.addEventListener("transitionend", () => alertDiv.remove());
        }, 5000);
      }

      // Show loading spinner
      function showSpinner() {
        spinnerContainer.style.display = "flex";
        document.body.style.overflow = "hidden"; // Prevent scrolling
      }

      // Hide loading spinner
      function hideSpinner() {
        spinnerContainer.style.display = "none";
        document.body.style.overflow = "auto"; // Re-enable scrolling
      }

      // Submit form handler
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = pdfInput.files[0];
        if (!file) {
          showAlert("No PDF file selected!", "danger");
          return;
        }
        if (file.type !== "application/pdf") {
          showAlert("Please upload a valid PDF file.", "danger");
          return;
        }

        showSpinner();
        submitBtn.disabled = true;
        resultsContainer.innerHTML = "";
        alertsContainer.innerHTML = "";

        const formData = new FormData(form);
        
        try {
          const response = await fetch('/summarize', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          
          if (data.error) {
            showAlert(data.error, "danger");
          } else {
            resultsContainer.innerHTML = `
              <div class="summary-box">
                <h5 class="mb-3">Summary (${data.language})</h5>
                <p>${escapeHtml(data.summary)}</p>
              </div>
            `;
          }
        } catch (error) {
          console.error('Error:', error);
          showAlert("An error occurred while processing the file. Please try again.", "danger");
        } finally {
          hideSpinner();
          submitBtn.disabled = false;
        }
      });

      // Simple HTML escape to prevent injection in summary output
      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Initialize everything
      function init() {
        loadTheme();
        initFileSelection();
      }

      init();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
