<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF SmartNotes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 2rem;
    }
    .drop-zone {
      border: 2px dashed #6c757d;
      padding: 2rem;
      text-align: center;
      border-radius: 1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .drop-zone.dragover {
      background-color: rgba(0, 123, 255, 0.1);
    }
    .summary-box {
      background-color: var(--bs-secondary-bg);
      border: 1px solid var(--bs-border-color);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 2rem;
    }
    .spinner-border {
      width: 2rem;
      height: 2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">ðŸ“„ PDF SmartNotes</h1>
      <button id="themeToggle" class="btn btn-outline-secondary">
        <i class="bi bi-sun-fill"></i> Light Mode
      </button>
    </div>

    <form id="uploadForm" enctype="multipart/form-data" action="/summarize" method="POST">
      <div id="dropZone" class="drop-zone mb-3">
        <p class="mb-0">Drag & Drop your PDF here or click to select</p>
        <input type="file" name="pdf" id="pdfInput" accept="application/pdf" hidden required />
      </div>
      <div class="mb-3">
        <label for="languageSelect" class="form-label">Select Language:</label>
        <select class="form-select" id="languageSelect" name="language">
          <option value="english" selected>English</option>
          <option value="hindi">Hindi</option>
        </select>
      </div>
      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">
          <span class="spinner-border spinner-border-sm me-2" id="spinner" style="display: none;"></span>
          Generate Notes
        </button>
        <div class="progress mt-2" style="height: 6px;">
          <div id="uploadProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
        </div>
      </div>
    </form>

    <div id="results" class="mt-4"></div>
  </div>

  <script>
    const html = document.documentElement;
    const themeToggle = document.getElementById("themeToggle");
    const form = document.getElementById("uploadForm");
    const dropZone = document.getElementById("dropZone");
    const pdfInput = document.getElementById("pdfInput");
    const spinner = document.getElementById("spinner");
    const uploadProgress = document.getElementById("uploadProgress");
    const resultsContainer = document.getElementById("results");

    // Drag and drop handling
    function initFileSelection() {
      dropZone.addEventListener("click", () => pdfInput.click());

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("dragover");
        if (e.dataTransfer.files.length) {
          pdfInput.files = e.dataTransfer.files;
        }
      });
    }

    // Show alert
    function showAlert(message, type = "info") {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
      alertDiv.role = "alert";
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      dropZone.parentElement.insertBefore(alertDiv, dropZone.nextSibling);
    }

    // Theme Toggle
    themeToggle.addEventListener("click", () => {
      if (html.getAttribute("data-bs-theme") === "dark") {
        html.setAttribute("data-bs-theme", "light");
        themeToggle.innerHTML = `<i class="bi bi-moon-fill"></i> Dark Mode`;
      } else {
        html.setAttribute("data-bs-theme", "dark");
        themeToggle.innerHTML = `<i class="bi bi-sun-fill"></i> Light Mode`;
      }
    });

    // Submit form
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const file = pdfInput.files[0];
      if (!file) {
        showAlert("No PDF file selected!", "danger");
        return;
      }

      spinner.style.display = "inline-block";
      form.querySelector("button").disabled = true;
      resultsContainer.innerHTML = ""; // Clear previous results

      const formData = new FormData(form);
      const xhr = new XMLHttpRequest();

      xhr.open("POST", "/summarize", true);

      xhr.upload.addEventListener("progress", function (e) {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          uploadProgress.style.width = percent + "%";
        }
      });

      xhr.onload = function () {
        spinner.style.display = "none";
        form.querySelector("button").disabled = false;
        uploadProgress.style.width = "0%";

        if (xhr.status === 200) {
          try {
            const data = JSON.parse(xhr.responseText);

            // Create summary box
            const summaryBox = document.createElement('div');
            summaryBox.className = 'summary-box';

            const title = document.createElement('h5');
            title.textContent = 'Summary';

            const summaryParagraph = document.createElement('p');
            summaryParagraph.textContent = data.summary || "No summary returned.";

            // Download buttons
            const btnContainer = document.createElement('div');
            btnContainer.className = 'mt-3';

            const btnTxt = document.createElement('button');
            btnTxt.className = 'btn btn-outline-primary btn-sm me-2';
            btnTxt.textContent = 'Download TXT';
            btnTxt.type = 'button';
            btnTxt.onclick = () => {
              window.open(`/download/txt/${encodeURIComponent(data.filename)}?summary=${encodeURIComponent(data.summary)}`, '_blank');
            };

            const btnPdf = document.createElement('button');
            btnPdf.className = 'btn btn-outline-primary btn-sm';
            btnPdf.textContent = 'Download PDF';
            btnPdf.type = 'button';
            btnPdf.onclick = () => {
              window.open(`/download/pdf/${encodeURIComponent(data.filename)}?summary=${encodeURIComponent(data.summary)}`, '_blank');
            };

            btnContainer.appendChild(btnTxt);
            btnContainer.appendChild(btnPdf);

            summaryBox.appendChild(title);
            summaryBox.appendChild(summaryParagraph);
            summaryBox.appendChild(btnContainer);

            resultsContainer.appendChild(summaryBox);

          } catch (err) {
            showAlert("Failed to parse server response.", "danger");
          }
        } else {
          let errMsg = "An error occurred while processing the file. Please try again.";
          try {
            const errData = JSON.parse(xhr.responseText);
            if (errData.error) errMsg = errData.error;
          } catch {}
          showAlert(errMsg, "danger");
        }
      };

      xhr.onerror = function () {
        spinner.style.display = "none";
        form.querySelector("button").disabled = false;
        uploadProgress.style.width = "0%";
        showAlert("Failed to send the request. Please check your internet connection.", "danger");
      };

      xhr.send(formData);
    });

    initFileSelection();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
